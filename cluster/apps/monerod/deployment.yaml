---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: monerod
  namespace: monerod
spec:
  selector:
    matchLabels:
      app: monerod
  replicas: 1
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: monerod
    spec:
      initContainers:
        - name: init-chown-config
          image: busybox:1.35.0
          command:
            - /bin/chown
            - -R
            - "568:568"
            - /config
          volumeMounts:
            - mountPath: /config
              name: monerod
      containers:
        - name: monerod
          image: tccr.io/truecharts/monero-node
          env:
            - name: TZ
              value: "${TIMEZONE}"
            - name: PUID
              value: "568"
            - name: USER_ID
              value: "568"
            - name: UID
              value: "568"
            - name: UMASK
              value: "2"
            - name: UMASK_SET
              value: "2"
            - name: PGID
              value: "568"
            - name: GROUP_ID
              value: "568"
            - name: GID
              value: "568"
            - name: NVIDIA_VISIBLE_DEVICES
              value: void
            - name: name
              value: monerod
          ports:
            - containerPort: 18080
              name: main
              protocol: TCP
            - containerPort: 18081
              name: port2
              protocol: TCP
          resources:
            requests:
              cpu: 400m
              memory: 512Mi
            limits:
              cpu: 600m
              memory: 1024Mi
          livenessProbe:
            failureThreshold: 5
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 18080
            timeoutSeconds: 5
          readinessProbe:
            failureThreshold: 5
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 18080
            timeoutSeconds: 5
          startupProbe:
            failureThreshold: 60
            initialDelaySeconds: 10
            periodSeconds: 5
            successThreshold: 1
            tcpSocket:
              port: 18080
            timeoutSeconds: 2
          securityContext:
            allowPrivilegeEscalation: false
            capabilities: {}
            privileged: false
            readOnlyRootFilesystem: false
            runAsNonRoot: false
          volumeMounts:
            - mountPath: /home/monero/.bitmonero
              name: monerod
      restartPolicy: Always
      nodeSelector:
        feature.node.kubernetes.io/custom-usb-backupdrive: "true"
      volumes:
        - name: monerod
          persistentVolumeClaim:
            claimName: monerod-local