---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &name plex-meta-manager
  namespace: media
spec:
  interval: 5m
  chart:
    spec:
      chart: app-template
      version: 2.3.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
      interval: 5m
  targetNamespace: media
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    fullnameOverride: *name
    defaultPodOptions:
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
        fsGroupChangePolicy: "OnRootMismatch"
    controllers:
      main:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          main:
            image:
              repository: meisnate12/plex-meta-manager
              tag: v1.19.1
            env:
              TZ: "${TIMEZONE}"
              PMM_READ_ONLY_CONFIG: "True"
            resources:
              requests:
                cpu: 50m
                memory: 100Mi
    configMaps:
      config:
        enabled: true
        data:
          config.yml: |
            libraries:
              Movies:                        # These are names of libraries in your Plex
                operations:
                  delete_collections:
                    configured: false
                    managed: false
                metadata_path:
                - pmm: audio_language
                  template_variables:
                    include:
                    - no
                    name_format: <<key_name>>
                    use_other: false
                    use_separator: false
                    sort_by: title.asc
                - file: /config/movies.yml
                overlay_path:
                - remove_overlays: true
            settings:
              asset_directory: /temp/assets
              asset_folders: true
              assets_for_all: true
              verify_ssl: false
              cache: true
              cache_expiration: 60
              asset_depth: 0
              create_asset_folders: false
              prioritize_assets: false
              dimensional_asset_rename: false
              download_url_assets: false
              show_missing_assets: true
              show_missing_season_assets: false
              show_missing_episode_assets: false
              show_asset_not_needed: true
              sync_mode: append
              default_collection_order:
              minimum_items: 1
              item_refresh_delay: 0
              delete_below_minimum: false
              delete_not_scheduled: false
              run_again_delay: 0
              missing_only_released: false
              only_filter_missing: false
              show_unmanaged: true
              show_unconfigured: true
              show_filtered: false
              show_options: false
              show_missing: true
              save_report: false
              tvdb_language: default
              ignore_ids:
              ignore_imdb_ids:
              playlist_sync_to_users: all
              playlist_exclude_users:
              playlist_report: true
              custom_repo:
              check_nightly: false
            plex:                            # Can be individually specified per library as well; REQUIRED for the script to run
              url: https://plex.media.svc.cluster.local:32400
              token: ${SECRET_PLEX_TOKEN}
              timeout: 60
              db_cache:
              clean_bundles: false
              empty_trash: false
              optimize: false
            tmdb:                            # REQUIRED for the script to run
              apikey: ${SECRET_TMDB_APIKEY}
              language: en
              cache_expiration: 60
              region: NO
            webhooks:
              changes:
                ${SECRET_PMM_WEBHOOK}
              error:
                ${SECRET_PMM_WEBHOOK}
              delete:
                ${SECRET_PMM_WEBHOOK}
              version:
              run_start:
              run_end:
          movies.yml: |
            collections:
              Christopher Nolan:
                tmdb_director: 525
              The Fast and the Furious:
                tmdb_collection: 9485
              Harry Potter:
                tmdb_collection: 1241
              The Lord of the Rings:
                tmdb_collection: 119
              Matrix:
                tmdb_collection: 2344
              Mission Impossible:
                tmdb_collection: 87359
              Pirates of the Carribean:
                tmdb_collection: 295
              Terminator:
                tmdb_collection: 528
              Transformers:
                tmdb_collection: 8650
              X-Men:
                tmdb_collection: 748
    service:
      main:
        enabled: false
    persistence:
      config:
        enabled: true
        type: configMap
        name: plex-meta-manager-config
        advancedMounts:
          main:
            main:
              - path: /config/config.yml
                subPath: config.yml
              - path: /config/movies.yml
                subPath: movies.yml
      temp:
        existingClaim: plex-meta-manager