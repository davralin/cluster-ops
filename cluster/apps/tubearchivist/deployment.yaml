---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tubearchivist
  namespace: tubearchivist
spec:
  selector:
    matchLabels:
      app: tubearchivist
  replicas: 1
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        backup.velero.io/backup-volumes: tubearchivist-media,tubearchivist-cache,tubearchivist-es,tubearchivist-redis
      labels:
        app: tubearchivist
    spec:
      containers:
        - name: ta
          image: bbilly1/tubearchivist:v0.2.3
          ports:
            - name: http
              containerPort: 8000
          env:
            - name: TZ
              value: "${TIMEZONE}"
            - name: ES_URL
              value: "http://localhost:9200"
            - name: TA_HOST
              value: "tube.${SECRET_PUBLIC_DOMAIN}"
            - name: REDIS_HOST
              value: "localhost"
            - name: TA_USERNAME
              valueFrom:
                secretKeyRef:
                  name: tubearchivist-secrets
                  key: TA_USERNAME
            - name: TA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tubearchivist-secrets
                  key: TA_PASSWORD
            - name: ELASTIC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tubearchivist-secrets
                  key: ELASTIC_PASSWORD
          volumeMounts:
            - name: tubearchivist-cache
              mountPath: /youtube
            - name: tubearchivist-media
              mountPath: /cache
        - name: es
          image: elasticsearch:8.4.3
          ports:
            - name: es-http
              containerPort: 9200
          env:
            - name: TZ
              value: "${TIMEZONE}"
            - name: xpack.security.enabled
              value: "true"
            - name: discovery.type
              value: "single-node"
            - name: ES_JAVA_OPTS
              value: "-Xms512m -Xmx512m"
            - name: ELASTIC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: tubearchivist-secrets
                  key: ELASTIC_PASSWORD
          volumeMounts:
            - name: tubearchivist-es
              mountPath: /usr/share/elasticsearch/data
        - name: redis
          image: bbilly1/rejson:v2.2.0
          ports:
            - name: redis
              containerPort: 6379
          env:
            - name: TZ
              value: "${TIMEZONE}"
          volumeMounts:
            - name: tubearchivist-redis
              mountPath: /data
      restartPolicy: Always
      volumes:
        - name: tubearchivist-media
          persistentVolumeClaim:
            claimName: tubearchivist-media
        - name: tubearchivist-cache
          persistentVolumeClaim:
            claimName: tubearchivist-cache
        - name: tubearchivist-es
          persistentVolumeClaim:
            claimName: tubearchivist-es
        - name: tubearchivist-redis
          persistentVolumeClaim:
            claimName: tubearchivist-redis